# Atomic

**아토믹(Atomic)**이란 **“더 이상 쪼갤 수 없는 단위”**를 뜻하는 용어이다.
이 개념은 **컴퓨터 과학, 특히 동시성(concurrency)이나 멀티스레드 프로그래밍**에서 자주 사용된다.

---

### 핵심 개념

**아토믹 연산(Atomic Operation)**이란,
한 번 시작되면 **다른 스레드나 프로세스가 끼어들 수 없는 연산**을 의미한다.
즉, **연산 전체가 한 덩어리로 처리되어야 하며**, 중간 단계가 외부에 노출되지 않는 것이다.

---

### 예시

```csharp
int count = 0;
count++; 
```

`count++`는 겉보기에는 한 줄짜리 연산이지만 실제로는

1. count 값을 읽고
2. 1을 더한 후
3. 다시 count에 저장하는
   세 단계로 이루어진다.

따라서 이 연산은 **아토믹하지 않다**.
여러 스레드가 동시에 `count++`를 실행하면 값이 꼬일 수 있다.

---

### 아토믹 연산을 위한 `Interlocked` 클래스

C#에서는 **`Interlocked` 클래스**를 통해 **CPU 수준에서 보장되는 아토믹 연산**을 수행할 수 있다.

```csharp
Interlocked.Increment(ref count);
```

이 코드는 여러 스레드가 동시에 접근해도 **값이 절대 꼬이지 않는 증가 연산**이다.
CPU가 이 명령어를 한 번에 처리하기 때문에 **진정한 원자성(Atomicity)**이 보장된다.

---

### 정리

| 구분          | 설명                                                             |
| ----------- | -------------------------------------------------------------- |
| **뜻**       | 더 이상 나눌 수 없는, 끼어들 수 없는 단위이다                                    |
| **주 사용 맥락** | 멀티스레드, 동시성 제어이다                                                |
| **C# 예시**   | `Interlocked.Add`, `Interlocked.Exchange`, `Volatile.Read` 등이다 |
| **의미**      | 연산이 중간에 끊기지 않고 한 번에 수행되는 성질이다                                  |

---

### 트랜잭션과의 관계

데이터베이스의 트랜잭션에서도 **아토믹성(Atomicity)**이라는 용어가 사용된다.
트랜잭션에서의 아토믹성은 **“모든 작업이 전부 수행되거나, 전혀 수행되지 않아야 한다”**는 성질을 의미한다.
즉, 데이터 변경이 부분적으로 적용되는 일은 없어야 한다는 것이다.

# 내부 작동

CPU의 버스 락(Bus Lock) 또는 **캐시 라인 락(Cache Line Lock)**을 통해
다른 CPU가 해당 메모리 영역에 접근하는 것을 막는다.

과거(단일 버스 구조일 때)

lock은 CPU 버스를 완전히 잠그는 방식으로 구현되었다.
즉, 명령이 끝날 때까지 다른 CPU가 메모리에 접근할 수 없었다.

현재(멀티코어, 캐시 일관성 시스템일 때)

요즘 CPU에서는 버스를 직접 잠그지 않고,
캐시 라인 단위로 락을 건다.
즉, 변경하려는 메모리가 속한 캐시 라인을 독점(Exclusive) 상태로 만들어
다른 코어가 접근하지 못하게 한다.
이건 MESI 캐시 일관성 프로토콜로 제어된다.